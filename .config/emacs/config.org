#+TITLE: Configration Emacs Code

* init

** モダンなpackage manager の leaf を使用する

#+begin_src emacs-lisp :tangle yes
    (eval-and-compile
        (customize-set-variable
         'package-archives '(("gnu" . "https://elpa.gnu.org/packages/")
                             ("melpa" . "https://melpa.org/packages/")
  			   ("nongnu" . "https://elpa.nongnu.org/nongnu/")))
        (package-initialize)
        (use-package leaf :ensure t)

        (leaf leaf-keywords
          :ensure t
          :init
          (leaf blackout :ensure t)
          :config
          (leaf-keywords-init)))

    (leaf leaf-convert
      :doc "Convert many format to leaf format"
      :ensure t)
#+end_src


* Path 解決


#+begin_src emacs-lisp :tangle yes
(leaf exec-path-from-shell
  :ensure t
  :config
  (exec-path-from-shell-initialize))
#+end_src

* vim 関連

** vim like な keybind


#+begin_src emacs-lisp :tangle yes
  (leaf evil
    :doc "vim like keybind"
    :ensure t
    :hook ((after-init-hook . evil-mode))
    :init
    (setq evil-want-C-u-scroll t)
    :config
    (evil-set-leader 'normal (kbd "SPC"))  ; Neovimと同じくスペースをleaderに
    ;; xrefバッファでのキーバインド
    (with-eval-after-load 'xref
      (evil-define-key 'normal xref--xref-buffer-mode-map
        (kbd "RET") #'xref-goto-xref
        (kbd "q") #'quit-window
        "n" #'xref-next-line
        "p" #'xref-prev-line))
    ;; ウィンドウ移動 (Neovim互換)
    (evil-define-key 'normal 'global
      (kbd "C-h") #'windmove-left
      (kbd "C-j") #'windmove-down
      (kbd "C-k") #'windmove-up
      (kbd "C-l") #'windmove-right)
    ;; ウィンドウリサイズ
    (evil-define-key 'normal 'global
      (kbd "C-<up>") (lambda () (interactive) (shrink-window 2))
      (kbd "C-<down>") (lambda () (interactive) (enlarge-window 2))
      (kbd "C-<left>") (lambda () (interactive) (shrink-window-horizontally 2))
      (kbd "C-<right>") (lambda () (interactive) (enlarge-window-horizontally 2))))

  ;; split時の新ウィンドウの位置 (Neovim互換)
  (setq split-window-below t)   ; 水平分割時、新ウィンドウを下に
  (setq split-window-right t)   ; 垂直分割時、新ウィンドウを右に
#+end_src

* keybind

** (linux only) superkey を emacs の meta key として使用する

#+begin_src emacs-lisp :tangle yes
  (when (eq system-type 'gnu/linux)
    (setq x-super-keysym 'meta))
#+end_src

* 補完フレームワーク (Vertico + Consult + Orderless)

** Vertico - 縦型補完UI

#+begin_src emacs-lisp :tangle yes
  (leaf vertico
    :doc "Vertical completion UI"
    :ensure t
    :init
    (vertico-mode)
    (vertico-multiform-mode)  ; posframeに必要
    :config
    (setq vertico-count 15)
    (setq vertico-cycle t))

  ;; Floating window表示 (telescope風)
  (leaf vertico-posframe
    :doc "Show vertico in a floating frame"
    :ensure t
    :after vertico
    :config
    (vertico-posframe-mode 1)
    (setq vertico-posframe-parameters
          '((left-fringe . 8)
            (right-fringe . 8))))
#+end_src

** Orderless - スペース区切りで絞り込み

#+begin_src emacs-lisp :tangle yes
  (leaf orderless
    :doc "Orderless completion style"
    :ensure t
    :config
    (setq completion-styles '(orderless basic))
    (setq completion-category-overrides '((file (styles basic partial-completion)))))
#+end_src

** Consult - 検索・ナビゲーションコマンド

#+begin_src emacs-lisp :tangle yes
  (leaf consult
    :doc "Consulting completing-read"
    :ensure t
    :bind
    ;; Emacs標準キーバインド
    (("C-x b" . consult-buffer)
     ("C-s" . consult-line))
    :config
    (setq consult-preview-key "M-.")

    ;; Neovim互換キーバインド (leader = SPC)
    (with-eval-after-load 'evil
      ;; ファイル検索
      (evil-define-key 'normal 'global
        (kbd "<leader>ff") #'consult-fd            ; Find files
        (kbd "<leader>fr") #'consult-recent-file   ; Recent files
        (kbd "<leader>fb") #'consult-buffer)       ; Buffers
      ;; Grep
      (evil-define-key 'normal 'global
        (kbd "<leader>fg") #'consult-ripgrep       ; Live grep
        (kbd "<leader>fw") #'consult-line-thing-at-point  ; Grep word at point
        (kbd "<leader>fs") #'consult-line)         ; Search in buffer
      ;; Git (magitと連携)
      (evil-define-key 'normal 'global
        (kbd "<leader>gs") #'magit-status          ; Git status
        (kbd "<leader>gb") #'magit-branch          ; Git branches
        (kbd "<leader>gc") #'magit-log-current)    ; Git commits
      ;; ナビゲーション
      (evil-define-key 'normal 'global
        (kbd "<leader>fo") #'consult-outline       ; Outline
        (kbd "<leader>fi") #'consult-imenu)))      ; Imenu

  ;; カーソル位置の単語でconsult-line
  (defun consult-line-thing-at-point ()
    "Search for thing at point using consult-line."
    (interactive)
    (consult-line (thing-at-point 'symbol)))
#+end_src

** Marginalia - 補完候補に説明を追加

#+begin_src emacs-lisp :tangle yes
  (leaf marginalia
    :doc "Annotations in the minibuffer"
    :ensure t
    :init
    (marginalia-mode))
#+end_src

* org mode

** org file の 保存先

#+begin_src emacs-lisp :tangle yes
  (setq org-directory "~/dev/org-notes/")
  (setq org-default-notes-file "notes.org")
#+end_src

** Org-capture の 設定

*** キーバインド

#+begin_src emacs-lisp :tangle yes
  (define-key global-map "\C-cc" 'org-capture)
#+end_src

*** テンプレートメニューの設定

#+begin_src emacs-lisp :tangle yes
  (setq org-capture-templates
      '(("n" "日々の気づいたことをNote として Memo" entry (file+headline "~/dev/org-notes/notes.org" "Notes") "* %?\nEntered on %U\n %i\n %a")
        ("e" "emacs 関連の操作メモ" entry (file+headline "~/dev/org-notes/emacs.org" "Emacs-Notes") "* %?\n%U\n")
        ("j" "毎日の日記" entry (file+headline "~/dev/org-notes/journal.org" "Journal") "* %?\n%U\n")
        ))
#+end_src


* LSP 関連

** Emacs 標準の LSP client の eglot をいれる

#+begin_src emacs-lisp :tangle yes
  (leaf eglot
    :doc "lsp clinet"
    :ensure t
    :config
    (add-hook 'python-ts-mode-hook #'eglot-ensure)
    (add-hook 'sh-mode-hook #'eglot-ensure)
    (add-hook 'typescript-ts-mode-hook #'eglot-ensure)
    (add-hook 'tsx-ts-mode-hook #'eglot-ensure)
    (add-hook 'go-ts-mode-hook #'eglot-ensure)
    (add-hook 'json-ts-mode-hook #'eglot-ensure)
    )

  (leaf eldoc-box
    :doc "Display eldoc in a floating box (like Neovim hover)"
    :ensure t
    :config
    ;; マークダウンのコードブロックをシンタックスハイライト
    (defun my/eldoc-box-fontify-markdown-code-blocks ()
      "Fontify markdown code blocks in eldoc-box buffer."
      (goto-char (point-min))
      (while (re-search-forward "```\\([a-zA-Z0-9_-]*\\)\n\\(\\(?:.*\n\\)*?\\)```" nil t)
        (let* ((lang (match-string 1))
               (code (match-string 2))
               (mode (cond
                      ((member lang '("typescript" "ts" "tsx")) 'typescript-ts-mode)
                      ((member lang '("javascript" "js" "jsx")) 'typescript-ts-mode)
                      ((member lang '("python" "py")) 'python-ts-mode)
                      ((member lang '("go" "golang")) 'go-ts-mode)
                      ((member lang '("json")) 'json-ts-mode)
                      (t nil)))
               (fontified (if (and mode (fboundp mode))
                              (with-temp-buffer
                                (insert code)
                                (delay-mode-hooks (funcall mode))
                                (font-lock-ensure)
                                (buffer-string))
                            code)))
          (replace-match fontified t t))))
    (add-hook 'eldoc-box-buffer-hook #'my/eldoc-box-fontify-markdown-code-blocks))
#+end_src

** LSP キーバインド (Neovim互換)

evilモードでNeovimと同じキーバインドを使用できるようにする。

#+begin_src emacs-lisp :tangle yes
  (with-eval-after-load 'evil
    (with-eval-after-load 'eglot
      ;; 移動系 (Go to)
      (evil-define-key 'normal eglot-mode-map
        "gd" #'xref-find-definitions      ; 定義へ
        "gD" #'eglot-find-declaration     ; 宣言へ
        "gr" #'xref-find-references       ; 参照一覧
        "gi" #'eglot-find-implementation) ; 実装へ

      ;; コード操作 (SPC c = Code) - leader key
      (evil-define-key 'normal eglot-mode-map
        (kbd "<leader>cr") #'eglot-rename           ; リネーム
        (kbd "<leader>ca") #'eglot-code-actions     ; アクション
        (kbd "<leader>cf") #'eglot-format-buffer)   ; フォーマット

      ;; 診断 ([/] = 前後移動)
      (evil-define-key 'normal eglot-mode-map
        "[d" #'flymake-goto-prev-error              ; 前の診断
        "]d" #'flymake-goto-next-error              ; 次の診断
        (kbd "<leader>cd") #'flymake-show-buffer-diagnostics)))

  ;; K をeglotバッファでオーバーライド（evil-lookupより優先）
  (add-hook 'eglot-managed-mode-hook
            (lambda ()
              (evil-local-set-key 'normal "K" #'eldoc-box-help-at-point)))
#+end_src


** 各言語のmode 定義

*** nix

#+begin_src emacs-lisp :tangle yes
  (leaf nix-mode
    :ensure t
    :config
    (setq byte-compile-warnings '(not obsolute))
    :mode "\\.nix\\'")
#+end_src

** nixd を lsp として使用する

#+begin_src emacs-lisp :tangle yes
(with-eval-after-load 'eglot
  (add-to-list 'eglot-server-programs
               '(nix-mode . ("nixd"))))
#+end_src

* Color Themes

** doom emacs theme

#+begin_src emacs-lisp :tangle yes
  (leaf doom-themes
    :doc "emacs color theme"
    :ensure t
    :config
    (load-theme 'doom-tokyo-night t)
    (doom-themes-org-config)
    )
#+end_src

* treesitter

** treesit の設定

tree-sitter を使用した構文解析とハイライトを設定。
- font-lock-level 4 で詳細なハイライト
- 各言語のgrammarソースを定義
- auto-mode-alist で拡張子とモードを関連付け

#+begin_src emacs-lisp :tangle yes
  (leaf treesit
    :config
    (setq treesit-font-lock-level 4)
    (setq treesit-language-source-alist
          '((typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
            (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
            (javascript "https://github.com/tree-sitter/tree-sitter-javascript")
            (json "https://github.com/tree-sitter/tree-sitter-json")
            (python "https://github.com/tree-sitter/tree-sitter-python")
            (go "https://github.com/tree-sitter/tree-sitter-go")
            (gomod "https://github.com/camdencheek/tree-sitter-go-mod")
            (css "https://github.com/tree-sitter/tree-sitter-css")
            (html "https://github.com/tree-sitter/tree-sitter-html")
            (yaml "https://github.com/ikatyang/tree-sitter-yaml")
            (bash "https://github.com/tree-sitter/tree-sitter-bash")))
    ;; auto-mode-alist for tree-sitter modes
    (add-to-list 'auto-mode-alist '("\\.ts\\'" . typescript-ts-mode))
    (add-to-list 'auto-mode-alist '("\\.tsx\\'" . tsx-ts-mode))
    (add-to-list 'auto-mode-alist '("\\.js\\'" . typescript-ts-mode))
    (add-to-list 'auto-mode-alist '("\\.jsx\\'" . tsx-ts-mode))
    (add-to-list 'auto-mode-alist '("\\.json\\'" . json-ts-mode))
    (add-to-list 'auto-mode-alist '("\\.py\\'" . python-ts-mode))
    (add-to-list 'auto-mode-alist '("\\.go\\'" . go-ts-mode))
    (add-to-list 'auto-mode-alist '("go\\.mod\\'" . go-mod-ts-mode))
    (add-to-list 'auto-mode-alist '("\\.ya?ml\\'" . yaml-ts-mode))
    (add-to-list 'auto-mode-alist '("\\.css\\'" . css-ts-mode))
    (add-to-list 'auto-mode-alist '("\\.html?\\'" . html-ts-mode))
    ;; Install language grammar if not available
    (dolist (lang '(typescript tsx javascript json python go gomod css html yaml bash))
      (unless (treesit-language-available-p lang)
        (treesit-install-language-grammar lang)))
   )
#+end_src


** 自動でtreesitter の parser を install

#+begin_src emacs-lisp :tangle yes
  (leaf treesit-auto
    :ensure t
    :init
    (require 'treesit-auto)
    (global-treesit-auto-mode)
    :config
    (setq treesit-auto-install t)
   )
#+end_src


* filer(treemacs) の設定

** treemacs 本体


#+begin_src emacs-lisp :tangle yes
  (leaf treemacs
    :ensure t
    :config
    (treemacs-project-follow-mode t)  ; プロジェクト移動時に追従
    (treemacs-follow-mode t)          ; カーソル位置のファイルを追従
    (setq treemacs-is-never-other-window t))  ; other-windowでtreemacsを選択しない
#+end_src


** magit (Git操作)

#+begin_src emacs-lisp :tangle yes
  (leaf magit
    :doc "Git interface"
    :ensure t)
#+end_src

** treemacs-magit 連携

#+begin_src emacs-lisp :tangle yes
  (leaf treemacs-magit
    :after magit treemacs
    :ensure t)
#+end_src

* Claude Code Integration


#+begin_src emacs-lisp :tangle yes

    (leaf vterm
        :ensure t
        :config
        (setq vterm-shell "/bin/zsh")
        )

  (leaf eat
  :ensure 
  :hook (eshell-mode-hook . eat-eshell-mode))

  (setq claude-code-ide-terminal-backend 'eat)

      (leaf claude-code-ide
        :vc (:url "https://github.com/manzaltu/claude-code-ide.el" :rev :newest)
        :bind ("C-c C-'" . claude-code-ide-menu)
        :config
        (claude-code-ide-emacs-tools-setup))
#+end_src

* util 系

** Emacs外でファイルが更新されたときに、ファイルを読み込みし直す

#+begin_src emacs-lisp :tangle yes
  (leaf autorevert
    :doc "revert buffers when files on disk change"
    :global-minor-mode global-auto-revert-mode)
#+end_src


** 行数の表示

#+begin_src emacs-lisp :tangle yes
  (global-display-line-numbers-mode 1)
#+end_src

** 透明度の設定


#+begin_src emacs-lisp :tangle yes
(set-frame-parameter nil 'alpha '(90 . 80))
#+end_src

** 選択状態で入力したときに、選択範囲を消す

#+begin_src emacs-lisp :tangle yes
  (leaf delsel
    :doc "delete selection if you insert"
    :global-minor-mode delete-selection-mode)
#+end_src

** C-c t で ターミナル起動

#+begin_src emacs-lisp :tangle yes
  (global-set-key (kbd "C-c t") 'eat)
#+end_src

** Emacs の 設定ファイルを reload する 関数の定義

#+begin_src emacs-lisp :tangle yes
  (defun my/reload-emacs ()
    "reload emacs config file"
    (interactive)
    (load-file (concat user-emacs-directory "init.el"))
    )
#+end_src


